# Sources: https://github.com/wincent/wincent/blob/master/.tmux.conf

# This feels good on Dvorak
set-option -g prefix C-s

unbind C-b

# Transitioning to C-u for faster switch b/w latest windows
# bind C-s last-window
bind C-u last-window

set -g focus-events on

# open new window with location from the current window
bind c new-window -c '#{pane_current_path}'

# let windows be numbered starting with 1
set -g base-index 1

# mouse
set -g mouse on

# set -g mode-keys vi

# Don't signal activity in other windows via highlighting window's title
setw -g monitor-activity off

# navigating panes
bind -r    k select-pane -U
bind -r    j select-pane -D
bind -r    h select-pane -L
bind -r    l select-pane -R

set-option -g status-justify left
set-option -g status-bg '#0e0e0e'
set-option -g status-fg blue
set-option -g status-left-length 40

set -g history-limit 100000

# reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded..."

# automatically renumber window numbers on closing a pane
set -g renumber-windows on

# do not wait after ESC
set -sg escape-time 0

# move current window left/right
bind C-h swap-window -d -t -1
bind C-l swap-window -d -t +1

# spread the current pane and any panes next to it out evenly
bind e select-layout -E

# restore previous layout
bind u select-layout -o

set -g focus-events on

# as suggested by :checkhealth in neovim
# set -g default-terminal "tmux-256color"

# smart pane switching with awareness of vim splits
bind -n C-h run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-h) || tmux select-pane -L"
bind -n C-j run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-j) || tmux select-pane -D"
bind -n C-k run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-k) || tmux select-pane -U"
bind -n C-l run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-l) || tmux select-pane -R"

set -g status-right ''

# Copying selection in copy-mode:

# outside of popup
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "/usr/bin/pbcopy"
# inside of popup (weird quirk, allededly related to 'emacs mode')
bind -T copy-mode y send -X copy-pipe-and-cancel "/usr/bin/pbcopy"

# Open panes in the same dir
bind j split-window -c "#{pane_current_path}"
# bind l split-window -h -c "#{pane_current_path}" \; select-layout even-horizontal
bind l split-window -h -c "#{pane_current_path}"

# Window titles
setw -g window-status-format '#I:#{b:pane_current_path}:#{pane_current_command} '
setw -g window-status-current-format '#{?window_zoomed_flag,#[fg=lightgreen],#[fg=default]}#I:#{b:pane_current_path}:#{pane_current_command}#[fg=default] '
# setw -g window-status-current-format '#I:#{b:pane_current_path}:#{pane_current_command}'
# setw -g window-status-current-format '#I:#{pane_current_command}'
set-window-option -g window-status-current-style fg=color249,bold
set-window-option -g window-status-style fg=colour244
set-window-option -g aggressive-resize

# Kill current session and jump back to the last one
bind k run-shell '
  cur=$(tmux display-message -p "#{session_name}");
  prev=$(tmux display-message -p "#{client_last_session}");
  if [ -n "$prev" ] && [ "$prev" != "$cur" ]; then
    tmux switch-client -t "$prev";
    tmux kill-session -t "$cur";
  else
    tmux display-message "No previous session to switch to";
  fi
'

# Enables incremental searchin copy-mode-vi
bind -T copy-mode-vi / command-prompt -i -p "search down" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "search up" "send -X search-backward-incremental \"%%%\""

bind -T copy-mode-vi Y run-shell "tmux save-buffer - > /tmp/tmux-buffer && tmux run-shell -t=0 'cat /tmp/tmux-buffer | pbcopy'"

# Pane title format
set -g pane-border-format "#{b:pane_current_path}:#{pane_current_command}"

# Only show title (on top) when there's multiple panes
set-hook -g -w pane-focus-in "set-option -Fw pane-border-status '#{?#{e|>:#{window_panes},1},top,off}'"

# Misc colors

# menu selector (e.g. session list)
set -wg mode-style "fg=colour232,bg=colour242"

# command prompt
set -g message-style 'fg=colour231,bg=colour237'

# active/inactive panes
set -g window-active-style 'fg=colour250,bg=color232'
set -g window-style 'fg=colour250,bg=colour234'

# the pane border colors
set -g pane-active-border-style 'fg=color231,bg=color232'
set -g pane-border-style 'fg=color244,bg=color232'

# Properly pass shift-enter and ctrl-enter down the line
bind -n S-Enter send-keys Escape "[13;2u"
bind -n C-Enter send-keys Escape "[13;5u"


bind C-o run-shell '
  pane_id=$(tmux display -p "#{pane_id}");
  # send real ESC + [O (FocusLost)
  tmux send-keys -t "$pane_id" Escape "[O";
  tmux display-popup \
    -d "#{pane_current_path}" \
    -w 80% \
    -h 80% \
    -E "tmux new-session -A -s scratch \; set-window-option -t scratch: status off"
'
